name: FHIR IG Publication Request Workflow

on:
  issues:
    types: [opened]

jobs:
  create-publication-request:
    runs-on: ubuntu-latest

    steps:
      - name: Check out the repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Extract form data from issue body
        id: extract_data
        run: |
          # Extract values using grep and regex with better handling for line breaks
          VERSION=$(echo "${{ github.event.issue.body }}" | grep -oP '(?<=### Version\s+)[^\r\n]+')
          PATH=$(echo "${{ github.event.issue.body }}" | grep -oP '(?<=### IG Publication Path\s+)[^\r\n]+')
          CI_BUILD=$(echo "${{ github.event.issue.body }}" | grep -oP '(?<=### Continuous Integration \(CI\) Build URL\s+)[^\r\n]+')
          STATUS=$(echo "${{ github.event.issue.body }}" | grep -oP '(?<=### Publication Status\s+)[^\r\n]+')
          SEQUENCE=$(echo "${{ github.event.issue.body }}" | grep -oP '(?<=### Sequence\s+)[^\r\n]+')

          # Save extracted values as environment variables
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "PATH=$PATH" >> $GITHUB_ENV
          echo "CI_BUILD=$CI_BUILD" >> $GITHUB_ENV
          echo "STATUS=$STATUS" >> $GITHUB_ENV
          echo "SEQUENCE=$SEQUENCE" >> $GITHUB_ENV

      - name: Create the publication-request.json
        run: |
          echo '{
            "package-id": "your-package-id",
            "version": "'$VERSION'",
            "path": "'$PATH'",
            "ci-build": "'$CI_BUILD'",
            "status": "'$STATUS'",
            "sequence": "'$SEQUENCE'"
          }' > publication-request.json

      - name: Display the publication-request.json content
        run: |
          echo "Content of publication-request.json:"
          cat publication-request.json

      - name: Log Success
        run: echo "Success"
